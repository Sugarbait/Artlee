<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clear ALL Test Credentials - ARTLEE CRM</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        .warning {
            background: #ffebee;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid #f44336;
            font-weight: bold;
        }
        button {
            background: #f44336;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            margin: 5px;
        }
        button:hover {
            background: #d32f2f;
        }
        button.secondary {
            background: #2196F3;
        }
        button.secondary:hover {
            background: #1976D2;
        }
        .log {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
        }
        .log-entry {
            margin: 5px 0;
        }
        .log-entry.error {
            color: #f44336;
        }
        .log-entry.success {
            color: #4caf50;
        }
        .log-entry.warning {
            color: #ff9800;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üßπ Nuclear Credential Cleanup</h1>

        <div class="warning">
            ‚ö†Ô∏è This will delete ALL API credentials and force reload from Supabase!
        </div>

        <button onclick="nuclearCleanup()">üî• Nuclear Cleanup & Reload</button>
        <button class="secondary" onclick="showCurrentCredentials()">üëÄ Show Current Credentials</button>

        <div id="log" class="log" style="display: none;">
            <strong>Cleanup Log:</strong>
            <div id="logEntries"></div>
        </div>
    </div>

    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entriesDiv = document.getElementById('logEntries');
            logDiv.style.display = 'block';

            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            entriesDiv.appendChild(entry);

            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function showCurrentCredentials() {
            log('üìã Current credentials in localStorage:', 'info');
            const allKeys = Object.keys(localStorage);
            const settingsKeys = allKeys.filter(key => key.startsWith('settings_'));

            settingsKeys.forEach(key => {
                try {
                    const settings = JSON.parse(localStorage.getItem(key) || '{}');
                    if (settings.retellApiKey) {
                        log(`${key}:`, 'info');
                        log(`  API Key: ${settings.retellApiKey?.substring(0, 20)}...`, 'warning');
                        log(`  Call Agent: ${settings.callAgentId}`, 'warning');
                        log(`  SMS Agent: ${settings.smsAgentId}`, 'warning');
                    }
                } catch (e) {
                    log(`Error reading ${key}`, 'error');
                }
            });

            // Check sessionStorage
            const sessionBackup = sessionStorage.getItem('retell_credentials_backup');
            if (sessionBackup) {
                log('Found sessionStorage backup:', 'warning');
                log(sessionBackup.substring(0, 100) + '...', 'warning');
            }
        }

        function nuclearCleanup() {
            if (!confirm('This will DELETE ALL credentials. Are you sure?')) {
                return;
            }

            log('üöÄ Starting NUCLEAR cleanup...', 'info');

            try {
                // 1. Clear ALL sessionStorage
                log('Clearing ALL sessionStorage...', 'info');
                sessionStorage.clear();
                log('‚úì sessionStorage cleared', 'success');

                // 2. Clear memory backup
                log('Clearing memory backup...', 'info');
                localStorage.removeItem('retell_memory_backup');
                log('‚úì Memory backup cleared', 'success');

                // 3. Delete ALL API keys from ALL settings
                log('Deleting ALL API keys from settings...', 'info');
                const allKeys = Object.keys(localStorage);
                const settingsKeys = allKeys.filter(key => key.startsWith('settings_'));

                let deletedCount = 0;
                settingsKeys.forEach(key => {
                    try {
                        const settings = JSON.parse(localStorage.getItem(key) || '{}');

                        // Delete ALL credential fields
                        delete settings.retellApiKey;
                        delete settings.callAgentId;
                        delete settings.smsAgentId;
                        delete settings.encrypted_retell_api_key;
                        delete settings.encrypted_agent_config;
                        delete settings.retell_config;
                        delete settings.encrypted_api_keys;

                        localStorage.setItem(key, JSON.stringify(settings));
                        deletedCount++;
                        log(`‚úì Cleared ALL credentials from ${key}`, 'success');
                    } catch (e) {
                        log(`Error processing ${key}: ${e.message}`, 'error');
                    }
                });

                log(`‚úì Cleared credentials from ${deletedCount} settings files`, 'success');

                // 4. Clear dashboard error cache
                log('Clearing dashboard error cache...', 'info');
                localStorage.removeItem('dashboard_shown_errors');
                log('‚úì Dashboard error cache cleared', 'success');

                // 5. Clear ANY other credential storage
                log('Clearing other credential storage...', 'info');
                const credentialKeys = allKeys.filter(key =>
                    key.includes('credential') ||
                    key.includes('retell') ||
                    key.includes('api_key') ||
                    key.includes('agent')
                );
                credentialKeys.forEach(key => {
                    if (!key.startsWith('settings_')) {
                        localStorage.removeItem(key);
                        log(`‚úì Removed ${key}`, 'success');
                    }
                });

                log('üéâ NUCLEAR cleanup complete!', 'success');
                log('App will now reload and fetch credentials from Supabase...', 'info');

                // 6. Redirect to app
                setTimeout(() => {
                    window.location.href = 'http://localhost:2222';
                }, 2000);

            } catch (error) {
                log(`‚ùå Error during cleanup: ${error.message}`, 'error');
                alert('Error clearing credentials. Check console for details.');
                console.error(error);
            }
        }
    </script>
</body>
</html>
