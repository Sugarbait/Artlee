<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Last Login UI Test</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: 40px auto;
      padding: 20px;
      background: #1a1a1a;
      color: #e0e0e0;
    }
    h1 { color: #60a5fa; }
    .test-section {
      background: #2a2a2a;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      border: 1px solid #3a3a3a;
    }
    .success { color: #10b981; }
    .error { color: #ef4444; }
    .warning { color: #f59e0b; }
    button {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover { background: #2563eb; }
    pre {
      background: #1a1a1a;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
    }
    .result-box {
      margin: 10px 0;
      padding: 10px;
      border-radius: 4px;
      border-left: 4px solid;
    }
    .result-box.success { border-color: #10b981; background: #10b98120; }
    .result-box.error { border-color: #ef4444; background: #ef444420; }
    .result-box.warning { border-color: #f59e0b; background: #f59e0b20; }
  </style>
</head>
<body>
  <h1>üß™ Last Login UI Test</h1>
  <p>This test verifies that the Last Login fix is working in your browser.</p>

  <div class="test-section">
    <h2>Step 1: Check localStorage Cache</h2>
    <button onclick="checkCache()">Check Cache</button>
    <div id="cache-result"></div>
  </div>

  <div class="test-section">
    <h2>Step 2: Clear Outdated Cache</h2>
    <button onclick="clearCache()">Clear Cache</button>
    <div id="clear-result"></div>
  </div>

  <div class="test-section">
    <h2>Step 3: Verify Fix</h2>
    <button onclick="verifyFix()">Run Verification</button>
    <div id="verify-result"></div>
  </div>

  <div class="test-section">
    <h2>Step 4: Final Check</h2>
    <p>After running the tests above:</p>
    <button onclick="window.location.href='/user-management'">Go to User Management Page</button>
    <p style="margin-top: 10px;">Check if all users now show their last login times instead of "Never"</p>
  </div>

  <script>
    function checkCache() {
      const resultDiv = document.getElementById('cache-result');
      let html = '<h3>Cache Analysis:</h3>';

      const systemUsers = localStorage.getItem('systemUsers');

      if (systemUsers) {
        try {
          const users = JSON.parse(systemUsers);
          html += `<div class="result-box warning">Found ${users.length} cached users</div>`;

          // Check if users have lastLogin field
          let hasLastLogin = 0;
          let missingLastLogin = 0;

          users.forEach(user => {
            if (user.lastLogin !== undefined) {
              hasLastLogin++;
            } else {
              missingLastLogin++;
            }
          });

          if (missingLastLogin > 0) {
            html += `<div class="result-box error">‚ùå ${missingLastLogin} users missing lastLogin field (causing "Never" display)</div>`;
            html += '<div class="result-box warning">‚ö†Ô∏è Cache is outdated and needs to be cleared</div>';
          } else {
            html += `<div class="result-box success">‚úÖ All ${hasLastLogin} users have lastLogin field</div>`;
          }

          // Show sample data
          html += '<details><summary>View cached data (first 2 users)</summary><pre>';
          users.slice(0, 2).forEach(user => {
            html += `${user.email}: lastLogin = ${user.lastLogin || 'undefined'}\\n`;
          });
          html += '</pre></details>';

        } catch (e) {
          html += `<div class="result-box error">‚ùå Failed to parse cache: ${e.message}</div>`;
        }
      } else {
        html += '<div class="result-box success">‚úÖ No cached data found (will fetch fresh from database)</div>';
      }

      resultDiv.innerHTML = html;
    }

    function clearCache() {
      const resultDiv = document.getElementById('clear-result');
      let html = '<h3>Clearing Cache:</h3>';

      try {
        // Clear systemUsers cache
        localStorage.removeItem('systemUsers');
        html += '<div class="result-box success">‚úÖ Removed systemUsers cache</div>';

        // Clear any login stats
        let cleared = 0;
        const keysToRemove = [];
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key && key.includes('loginStats_')) {
            keysToRemove.push(key);
          }
        }

        keysToRemove.forEach(key => {
          localStorage.removeItem(key);
          cleared++;
        });

        if (cleared > 0) {
          html += `<div class="result-box success">‚úÖ Cleared ${cleared} login stat entries</div>`;
        }

        html += '<div class="result-box success">‚úÖ Cache cleared! Page will fetch fresh data on next load.</div>';

      } catch (e) {
        html += `<div class="result-box error">‚ùå Error clearing cache: ${e.message}</div>`;
      }

      resultDiv.innerHTML = html;
    }

    function verifyFix() {
      const resultDiv = document.getElementById('verify-result');
      let html = '<h3>Verification Results:</h3>';

      // Check if cache is clear
      const systemUsers = localStorage.getItem('systemUsers');

      if (!systemUsers) {
        html += '<div class="result-box success">‚úÖ Cache is clear - app will fetch fresh data</div>';
        html += '<div class="result-box success">‚úÖ Fix is ready to work!</div>';
        html += '<div class="result-box warning">‚ö†Ô∏è Now navigate to User Management to see the results</div>';
      } else {
        try {
          const users = JSON.parse(systemUsers);
          const hasIssue = users.some(u => u.lastLogin === undefined);

          if (hasIssue) {
            html += '<div class="result-box error">‚ùå Cache still has outdated data</div>';
            html += '<div class="result-box warning">‚ö†Ô∏è Click "Clear Cache" button above first</div>';
          } else {
            html += '<div class="result-box success">‚úÖ Cache has been updated with lastLogin fields</div>';
            html += '<div class="result-box success">‚úÖ Users should display correctly</div>';
          }
        } catch (e) {
          html += '<div class="result-box error">‚ùå Cache data is corrupted - clear it</div>';
        }
      }

      // Add final instructions
      html += '<h3>Next Step:</h3>';
      html += '<div class="result-box warning">Click "Go to User Management Page" to see if users display their last login times</div>';

      resultDiv.innerHTML = html;
    }

    // Auto-run cache check on load
    window.onload = () => {
      console.log('Last Login UI Test loaded');
      checkCache();
    };
  </script>
</body>
</html>