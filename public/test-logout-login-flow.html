<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Logout/Login Flow Test</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 900px;
      margin: 40px auto;
      padding: 20px;
      background: #1a1a1a;
      color: #e0e0e0;
      line-height: 1.6;
    }
    h1 { color: #60a5fa; }
    h2 { color: #34d399; margin-top: 30px; }
    .test-section {
      background: #2a2a2a;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      border: 1px solid #3a3a3a;
    }
    .success { color: #10b981; }
    .error { color: #ef4444; }
    .warning { color: #f59e0b; }
    button {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover { background: #2563eb; }
    .result-box {
      margin: 10px 0;
      padding: 15px;
      border-radius: 6px;
      border-left: 4px solid;
    }
    .result-box.success { border-color: #10b981; background: #10b98120; }
    .result-box.error { border-color: #ef4444; background: #ef444420; }
    .result-box.warning { border-color: #f59e0b; background: #f59e0b20; }
    .step {
      background: #374151;
      padding: 15px;
      margin: 10px 0;
      border-radius: 6px;
      border-left: 4px solid #6366f1;
    }
    .step h3 {
      margin-top: 0;
      color: #a5b4fc;
    }
    code {
      background: #1f2937;
      padding: 2px 6px;
      border-radius: 3px;
      color: #fbbf24;
    }
  </style>
</head>
<body>
  <h1>üß™ Logout/Login Flow Test</h1>
  <p>This test verifies that the logout and login bypass fix is working correctly.</p>

  <div class="test-section">
    <h2>Current Authentication State</h2>
    <button onclick="checkCurrentState()">Check State</button>
    <div id="state-result"></div>
  </div>

  <div class="test-section">
    <h2>Manual Test Steps</h2>

    <div class="step">
      <h3>Step 1: Test Normal Logout</h3>
      <p>1. Login to the application normally</p>
      <p>2. Go to User Management or Dashboard</p>
      <p>3. Logout using the logout button</p>
      <p>4. ‚úÖ You should be taken to the login page</p>
      <p>5. Refresh the page - ‚úÖ you should stay on login page</p>
    </div>

    <div class="step">
      <h3>Step 2: Test Login Session Persistence</h3>
      <p>1. Login successfully</p>
      <p>2. ‚úÖ You should reach dashboard/MFA screen</p>
      <p>3. Refresh the page - ‚úÖ you should stay logged in</p>
      <p>4. Close and reopen browser tab - ‚ö†Ô∏è you should need to login again</p>
    </div>

    <div class="step">
      <h3>Step 3: Test the Fix (Key Test)</h3>
      <p><strong>The Issue:</strong> After logout, waiting some time and returning causes MFA bypass</p>
      <p><strong>Test:</strong></p>
      <p>1. Logout completely</p>
      <p>2. Wait 30-60 seconds (or longer)</p>
      <p>3. Return to the application URL</p>
      <p>4. ‚úÖ <strong>Expected:</strong> You should see the LOGIN page</p>
      <p>5. ‚ùå <strong>Bug (fixed):</strong> Going directly to MFA page</p>
    </div>

    <div class="step">
      <h3>Step 4: Test Browser Session Handling</h3>
      <p>1. Open application in new incognito/private window</p>
      <p>2. ‚úÖ Should see login page (not MFA)</p>
      <p>3. Open application in new regular tab (after logout)</p>
      <p>4. ‚úÖ Should see login page (not MFA)</p>
    </div>
  </div>

  <div class="test-section">
    <h2>Automated Checks</h2>
    <button onclick="runAllTests()">Run All Tests</button>
    <div id="test-results"></div>
  </div>

  <script>
    function checkCurrentState() {
      const resultDiv = document.getElementById('state-result');
      let html = '<h3>Current State:</h3>';

      // Check authentication flags
      const currentUser = localStorage.getItem('currentUser');
      const justLoggedOut = localStorage.getItem('justLoggedOut');
      const forceLoginPage = localStorage.getItem('forceLoginPage');
      const appInitialized = sessionStorage.getItem('appInitialized');
      const userLoginTimestamp = localStorage.getItem('userLoginTimestamp');

      html += '<div class="result-box">';
      html += '<strong>Authentication State:</strong><br>';
      html += `‚Ä¢ Current User: ${currentUser ? '‚úÖ Found' : '‚ùå None'}<br>`;
      html += `‚Ä¢ App Initialized: ${appInitialized ? '‚úÖ Yes' : '‚ùå No'}<br>`;
      html += `‚Ä¢ Login Timestamp: ${userLoginTimestamp ? '‚úÖ ' + new Date(parseInt(userLoginTimestamp)).toLocaleString() : '‚ùå None'}<br>`;
      html += `‚Ä¢ Just Logged Out: ${justLoggedOut ? '‚ö†Ô∏è Yes' : '‚úÖ No'}<br>`;
      html += `‚Ä¢ Force Login Page: ${forceLoginPage ? '‚ö†Ô∏è Yes' : '‚úÖ No'}<br>`;
      html += '</div>';

      // Determine expected behavior
      if (currentUser && appInitialized && userLoginTimestamp && !justLoggedOut && !forceLoginPage) {
        html += '<div class="result-box success">‚úÖ User should be logged in and able to access app</div>';
      } else if (!currentUser || !appInitialized || !userLoginTimestamp || justLoggedOut || forceLoginPage) {
        html += '<div class="result-box warning">‚ö†Ô∏è User should be redirected to login page</div>';
      } else {
        html += '<div class="result-box error">‚ùå Unclear state - potential authentication issue</div>';
      }

      resultDiv.innerHTML = html;
    }

    function testLogoutCleanup() {
      console.log('Testing logout cleanup simulation...');

      // Simulate what logout should clean
      const itemsToCheck = [
        'currentUser',
        'justLoggedOut',
        'forceLoginPage',
        'freshMfaVerified',
        'mfa_verified',
        'userLoginTimestamp'
      ];

      const sessionItemsToCheck = [
        'appInitialized',
        'retell_credentials_backup'
      ];

      let issues = [];

      // Check localStorage items that should be cleared
      itemsToCheck.forEach(item => {
        if (localStorage.getItem(item)) {
          issues.push(`localStorage.${item} should be cleared after logout`);
        }
      });

      // Check sessionStorage items
      sessionItemsToCheck.forEach(item => {
        if (sessionStorage.getItem(item)) {
          issues.push(`sessionStorage.${item} should be cleared after logout`);
        }
      });

      return issues;
    }

    function runAllTests() {
      const resultDiv = document.getElementById('test-results');
      let html = '<h3>Test Results:</h3>';

      // Test 1: Logout cleanup
      html += '<h4>Test 1: Logout Cleanup</h4>';
      const cleanupIssues = testLogoutCleanup();
      if (cleanupIssues.length === 0) {
        html += '<div class="result-box success">‚úÖ All logout cleanup checks passed</div>';
      } else {
        html += '<div class="result-box error">‚ùå Logout cleanup issues found:<br>';
        cleanupIssues.forEach(issue => {
          html += `‚Ä¢ ${issue}<br>`;
        });
        html += '</div>';
      }

      // Test 2: Session consistency
      html += '<h4>Test 2: Session State Consistency</h4>';
      const currentUser = localStorage.getItem('currentUser');
      const appInitialized = sessionStorage.getItem('appInitialized');
      const userLoginTimestamp = localStorage.getItem('userLoginTimestamp');

      const hasUser = !!currentUser;
      const hasSession = !!appInitialized;
      const hasTimestamp = !!userLoginTimestamp;

      if ((hasUser && hasSession && hasTimestamp) || (!hasUser && !hasSession && !hasTimestamp)) {
        html += '<div class="result-box success">‚úÖ Session state is consistent</div>';
      } else {
        html += '<div class="result-box error">‚ùå Session state inconsistency detected:<br>';
        html += `‚Ä¢ Has User: ${hasUser}<br>`;
        html += `‚Ä¢ Has Session: ${hasSession}<br>`;
        html += `‚Ä¢ Has Timestamp: ${hasTimestamp}<br>`;
        html += 'These should all be true or all be false</div>';
      }

      // Test 3: MSAL state
      html += '<h4>Test 3: MSAL Token State</h4>';
      const msalKeys = Object.keys(localStorage).filter(key => key.startsWith('msal.'));
      if (msalKeys.length === 0) {
        html += '<div class="result-box success">‚úÖ No MSAL tokens found in localStorage</div>';
      } else {
        html += '<div class="result-box warning">‚ö†Ô∏è MSAL tokens found in localStorage:<br>';
        msalKeys.slice(0, 3).forEach(key => {
          html += `‚Ä¢ ${key}<br>`;
        });
        if (msalKeys.length > 3) {
          html += `‚Ä¢ ... and ${msalKeys.length - 3} more<br>`;
        }
        html += 'These may be cleared automatically by MSAL</div>';
      }

      resultDiv.innerHTML = html;
    }

    // Auto-run state check on load
    window.onload = () => {
      checkCurrentState();
      runAllTests();
    };
  </script>
</body>
</html>