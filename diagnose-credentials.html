<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ARTLEE Credentials Diagnostic</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #1e1e1e;
            color: #00ff00;
        }
        .section {
            background: #2d2d2d;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            border: 1px solid #00ff00;
        }
        .test-cred {
            color: #ff0000;
            font-weight: bold;
        }
        .real-cred {
            color: #00ff00;
            font-weight: bold;
        }
        button {
            background: #ff0000;
            color: white;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            margin: 5px;
            border-radius: 3px;
        }
        button:hover {
            background: #cc0000;
        }
        .warning {
            background: #ffaa00;
            color: #000;
            padding: 10px;
            margin: 10px 0;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <h1>üîç ARTLEE Credentials Diagnostic Tool</h1>

    <div class="warning">
        ‚ö†Ô∏è This tool scans ALL localStorage for credential data and shows you exactly what's stored.
    </div>

    <button onclick="scanCredentials()">üîé Scan All Credentials</button>
    <button onclick="clearTestCredentials()">üßπ Clear ALL Test Credentials</button>
    <button onclick="clearAllCredentials()">üí£ Nuclear Clear (Everything)</button>

    <div id="results"></div>

    <script>
        function isTestCredential(value) {
            if (!value) return false;
            const str = String(value);
            return str.includes('test_key_') ||
                   str.includes('test_call_agent_') ||
                   str.includes('test_sms_agent_');
        }

        function scanCredentials() {
            const results = document.getElementById('results');
            results.innerHTML = '<h2>üìä Scan Results</h2>';

            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            results.innerHTML += `<div class="section"><strong>Current User:</strong> ${currentUser.email || 'Not logged in'} (ID: ${currentUser.id || 'N/A'})</div>`;

            // Scan all settings_* keys
            const allKeys = Object.keys(localStorage);
            const settingsKeys = allKeys.filter(key => key.startsWith('settings_'));

            results.innerHTML += `<div class="section"><h3>Found ${settingsKeys.length} settings files</h3></div>`;

            settingsKeys.forEach(key => {
                try {
                    const settings = JSON.parse(localStorage.getItem(key) || '{}');

                    const hasApiKey = !!settings.retellApiKey;
                    const hasCallAgent = !!settings.callAgentId;
                    const hasSmsAgent = !!settings.smsAgentId;

                    const isApiKeyTest = isTestCredential(settings.retellApiKey);
                    const isCallAgentTest = isTestCredential(settings.callAgentId);
                    const isSmsAgentTest = isTestCredential(settings.smsAgentId);

                    if (hasApiKey || hasCallAgent || hasSmsAgent) {
                        results.innerHTML += `
                            <div class="section">
                                <strong>üìÅ ${key}</strong><br>
                                API Key: ${hasApiKey ? (isApiKeyTest ? '<span class="test-cred">TEST CREDENTIAL</span>' : '<span class="real-cred">REAL</span>') + ' - ' + (settings.retellApiKey?.substring(0, 20) || '') + '...' : '‚ùå Not set'}<br>
                                Call Agent: ${hasCallAgent ? (isCallAgentTest ? '<span class="test-cred">TEST CREDENTIAL</span>' : '<span class="real-cred">REAL</span>') + ' - ' + (settings.callAgentId || 'empty') : '‚ùå Not set'}<br>
                                SMS Agent: ${hasSmsAgent ? (isSmsAgentTest ? '<span class="test-cred">TEST CREDENTIAL</span>' : '<span class="real-cred">REAL</span>') + ' - ' + (settings.smsAgentId || 'empty') : '‚ùå Not set'}
                            </div>
                        `;
                    }
                } catch (e) {
                    results.innerHTML += `<div class="section">Error parsing ${key}: ${e.message}</div>`;
                }
            });

            // Check sessionStorage
            const sessionBackup = sessionStorage.getItem('retell_credentials_backup');
            if (sessionBackup) {
                results.innerHTML += `
                    <div class="section">
                        <strong>‚ö†Ô∏è Found sessionStorage backup:</strong><br>
                        ${sessionBackup.substring(0, 100)}...
                    </div>
                `;
            }

            // Check memory backup
            const memoryBackup = localStorage.getItem('retell_memory_backup');
            if (memoryBackup) {
                results.innerHTML += `
                    <div class="section">
                        <strong>‚ö†Ô∏è Found memory backup in localStorage:</strong><br>
                        ${memoryBackup.substring(0, 100)}...
                    </div>
                `;
            }
        }

        function clearTestCredentials() {
            if (!confirm('Clear ALL test credentials from localStorage?')) return;

            let clearedCount = 0;
            const allKeys = Object.keys(localStorage);
            const settingsKeys = allKeys.filter(key => key.startsWith('settings_'));

            settingsKeys.forEach(key => {
                try {
                    const settings = JSON.parse(localStorage.getItem(key) || '{}');
                    let modified = false;

                    if (isTestCredential(settings.retellApiKey)) {
                        delete settings.retellApiKey;
                        modified = true;
                    }
                    if (isTestCredential(settings.callAgentId)) {
                        delete settings.callAgentId;
                        modified = true;
                    }
                    if (isTestCredential(settings.smsAgentId)) {
                        delete settings.smsAgentId;
                        modified = true;
                    }

                    if (modified) {
                        localStorage.setItem(key, JSON.stringify(settings));
                        clearedCount++;
                    }
                } catch (e) {
                    console.error('Error processing', key, e);
                }
            });

            alert(`‚úÖ Cleared test credentials from ${clearedCount} files.\n\nRefresh the page and check Settings.`);
            scanCredentials();
        }

        function clearAllCredentials() {
            if (!confirm('‚ö†Ô∏è NUCLEAR OPTION: This will DELETE ALL credentials!\n\nAre you absolutely sure?')) return;

            sessionStorage.clear();
            localStorage.removeItem('retell_memory_backup');

            const allKeys = Object.keys(localStorage);
            const settingsKeys = allKeys.filter(key => key.startsWith('settings_'));

            settingsKeys.forEach(key => {
                try {
                    const settings = JSON.parse(localStorage.getItem(key) || '{}');
                    delete settings.retellApiKey;
                    delete settings.callAgentId;
                    delete settings.smsAgentId;
                    delete settings.encrypted_retell_api_key;
                    delete settings.encrypted_agent_config;
                    delete settings.retell_config;
                    delete settings.encrypted_api_keys;
                    localStorage.setItem(key, JSON.stringify(settings));
                } catch (e) {
                    console.error('Error', e);
                }
            });

            alert('‚úÖ Nuclear clear complete!\n\nRefresh the page and enter your credentials in Settings.');
            scanCredentials();
        }

        // Auto-scan on load
        scanCredentials();
    </script>
</body>
</html>
