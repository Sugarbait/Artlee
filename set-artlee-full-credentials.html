<!DOCTYPE html>
<html>
<head>
    <title>Set ARTLEE Credentials - Full Setup</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 700px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-top: 0;
        }
        .info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
        }
        .success {
            background: #4caf50;
            color: white;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
            display: none;
        }
        .error {
            background: #f44336;
            color: white;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
            display: none;
        }
        .progress {
            background: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
            display: none;
        }
        button {
            background: #2196f3;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #1976d2;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .credentials {
            margin: 20px 0;
            padding: 15px;
            background: #f9f9f9;
            border-left: 4px solid #2196f3;
        }
        code {
            background: #f5f5f5;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
        .steps {
            margin: 20px 0;
            padding: 15px;
            background: #f1f8e9;
            border-radius: 4px;
        }
        .steps ol {
            margin: 10px 0 0 0;
            padding-left: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê Set ARTLEE Credentials - Full Setup</h1>

        <div class="info">
            <strong>User Account:</strong><br>
            <code>create@artlee.agency</code>
            <br><br>
            <strong>User ID:</strong><br>
            <code>d4ca7563-c542-44b4-bb9c-f4d8fb5ab71a</code>
        </div>

        <div class="credentials">
            <strong>New Password:</strong><br>
            <code>test1000!</code>
        </div>

        <div class="steps">
            <strong>üìã This will:</strong>
            <ol>
                <li>‚úÖ Store credentials in localStorage (current device)</li>
                <li>‚úÖ Store credentials in Supabase database (cross-device)</li>
                <li>‚úÖ Enable login from any device</li>
            </ol>
        </div>

        <button id="setBtn" onclick="setFullCredentials()">Set Credentials (Local + Database)</button>

        <div class="progress" id="progress"></div>
        <div class="success" id="success"></div>
        <div class="error" id="error"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://cpkslvmydfdevdftieck.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNwa3Nsdm15ZGZkZXZkZnRpZWNrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY5MDAyOTUsImV4cCI6MjA2MjQ3NjI5NX0.IfkIVsp3AtLOyXDW9hq9bEvnozd9IaaUay244iDhWGE';
        const ENCRYPTION_KEY = '7f3e9a2b8c1d4f6e5a8b9c2d3e4f5a6b7c8d9e0f1a2b3c4d5e6f7a8b9c0d1e2f';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        function showProgress(msg) {
            const el = document.getElementById('progress');
            el.textContent = msg;
            el.style.display = 'block';
            console.log(msg);
        }

        function showSuccess(msg) {
            document.getElementById('progress').style.display = 'none';
            const el = document.getElementById('success');
            el.innerHTML = msg;
            el.style.display = 'block';
        }

        function showError(msg) {
            document.getElementById('progress').style.display = 'none';
            const el = document.getElementById('error');
            el.textContent = msg;
            el.style.display = 'block';
        }

        async function encryptString(text) {
            const encoder = new TextEncoder();
            const data = encoder.encode(text);

            const keyData = new Uint8Array(
                ENCRYPTION_KEY.match(/.{1,2}/g).map(byte => parseInt(byte, 16))
            );

            const key = await crypto.subtle.importKey(
                'raw',
                keyData,
                { name: 'AES-GCM' },
                false,
                ['encrypt']
            );

            const iv = crypto.getRandomValues(new Uint8Array(16));
            const encrypted = await crypto.subtle.encrypt(
                { name: 'AES-GCM', iv: iv },
                key,
                data
            );

            const encryptedArray = new Uint8Array(encrypted);
            const ivBase64 = btoa(String.fromCharCode(...iv));
            const dataBase64 = btoa(String.fromCharCode(...encryptedArray));

            return JSON.stringify({
                iv: ivBase64,
                data: dataBase64.slice(0, -24),
                authTag: btoa(String.fromCharCode(...encryptedArray.slice(-16)))
            });
        }

        async function setFullCredentials() {
            const button = document.getElementById('setBtn');
            button.disabled = true;

            const userId = 'd4ca7563-c542-44b4-bb9c-f4d8fb5ab71a';
            const email = 'create@artlee.agency';
            const password = 'test1000!';

            try {
                // STEP 1: Encrypt password
                showProgress('üîê Step 1/5: Encrypting password...');
                const encryptedPassword = await encryptString(password);

                // STEP 2: Create credentials object
                showProgress('üì¶ Step 2/5: Creating credentials object...');
                const credentials = {
                    email: email,
                    password: encryptedPassword,
                    tempPassword: false
                };

                // STEP 3: Encrypt credentials object
                showProgress('üîê Step 3/5: Encrypting credentials object...');
                const encryptedCredentials = await encryptString(JSON.stringify(credentials));

                // STEP 4: Store in localStorage
                showProgress('üíæ Step 4/5: Storing in localStorage (current device)...');
                localStorage.setItem(`userCredentials_${userId}`, encryptedCredentials);
                console.log('‚úÖ Stored in localStorage');

                // STEP 5: Store in Supabase database
                showProgress('‚òÅÔ∏è Step 5/5: Storing in Supabase database (cross-device)...');

                const { data, error } = await supabase
                    .from('user_profiles')
                    .upsert({
                        user_id: userId,
                        encrypted_retell_api_key: encryptedCredentials,
                        updated_at: new Date().toISOString()
                    }, {
                        onConflict: 'user_id'
                    });

                if (error) {
                    console.error('Database error:', error);
                    showError('‚ùå Database Error: ' + error.message + '\n\nCredentials saved to localStorage only. Login will work on this device.');
                } else {
                    console.log('‚úÖ Stored in database');
                    showSuccess(
                        '‚úÖ <strong>Credentials set successfully!</strong><br><br>' +
                        'üìç <strong>Stored in:</strong><br>' +
                        '&nbsp;&nbsp;‚Ä¢ localStorage (current device)<br>' +
                        '&nbsp;&nbsp;‚Ä¢ Supabase database (cross-device)<br><br>' +
                        'üîì <strong>Login Details:</strong><br>' +
                        '&nbsp;&nbsp;‚Ä¢ Email: <code>create@artlee.agency</code><br>' +
                        '&nbsp;&nbsp;‚Ä¢ Password: <code>test1000!</code><br><br>' +
                        'üåê Login at: <a href="http://localhost:3002" style="color: white; text-decoration: underline;">http://localhost:3002</a>'
                    );
                }

                button.disabled = false;

            } catch (error) {
                console.error('‚ùå Error:', error);
                showError('‚ùå Error: ' + error.message);
                button.disabled = false;
            }
        }
    </script>
</body>
</html>
