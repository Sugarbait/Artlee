<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clear Test Credentials - ARTLEE CRM</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        .info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid #2196F3;
        }
        .warning {
            background: #fff3e0;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid #ff9800;
        }
        button {
            background: #f44336;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
        }
        button:hover {
            background: #d32f2f;
        }
        .success {
            background: #c8e6c9;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            border-left: 4px solid #4caf50;
            display: none;
        }
        .log {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 300px;
            overflow-y: auto;
        }
        .log-entry {
            margin: 5px 0;
        }
        .log-entry.error {
            color: #f44336;
        }
        .log-entry.success {
            color: #4caf50;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üßπ Clear Test Credentials</h1>

        <div class="info">
            <strong>Purpose:</strong> This tool removes all cached test credentials from your browser and forces the app to reload real credentials from Supabase cloud storage.
        </div>

        <div class="warning">
            <strong>‚ö†Ô∏è Warning:</strong> This will clear all cached API credentials. Make sure your real credentials are saved in Supabase before proceeding.
        </div>

        <button onclick="clearTestCredentials()">Clear Test Credentials & Reload</button>

        <div id="success" class="success">
            ‚úÖ Test credentials cleared successfully! Redirecting to app...
        </div>

        <div id="log" class="log" style="display: none;">
            <strong>Cleanup Log:</strong>
            <div id="logEntries"></div>
        </div>
    </div>

    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entriesDiv = document.getElementById('logEntries');
            logDiv.style.display = 'block';

            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            entriesDiv.appendChild(entry);

            // Auto-scroll to bottom
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearTestCredentials() {
            log('üöÄ Starting credential cleanup...', 'info');

            try {
                // 1. Clear sessionStorage backup
                log('Clearing sessionStorage backup...', 'info');
                sessionStorage.removeItem('retell_credentials_backup');
                log('‚úì sessionStorage cleared', 'success');

                // 2. Clear memory backup
                log('Clearing memory backup...', 'info');
                localStorage.removeItem('retell_memory_backup');
                log('‚úì Memory backup cleared', 'success');

                // 3. Clear all settings files with test credentials
                log('Scanning for test credentials in settings...', 'info');
                const allKeys = Object.keys(localStorage);
                const settingsKeys = allKeys.filter(key => key.startsWith('settings_'));

                let clearedCount = 0;
                settingsKeys.forEach(key => {
                    try {
                        const settings = JSON.parse(localStorage.getItem(key) || '{}');
                        let modified = false;

                        // Check if it has test credentials
                        if (settings.retellApiKey && settings.retellApiKey.includes('test_key_')) {
                            log(`Found test API key in ${key}`, 'info');
                            delete settings.retellApiKey;
                            modified = true;
                        }
                        if (settings.callAgentId && settings.callAgentId.includes('test_call_agent_')) {
                            log(`Found test call agent in ${key}`, 'info');
                            delete settings.callAgentId;
                            modified = true;
                        }
                        if (settings.smsAgentId && settings.smsAgentId.includes('test_sms_agent_')) {
                            log(`Found test SMS agent in ${key}`, 'info');
                            delete settings.smsAgentId;
                            modified = true;
                        }

                        if (modified) {
                            localStorage.setItem(key, JSON.stringify(settings));
                            clearedCount++;
                            log(`‚úì Cleared test credentials from ${key}`, 'success');
                        }
                    } catch (e) {
                        log(`Error processing ${key}: ${e.message}`, 'error');
                    }
                });

                log(`‚úì Cleared test credentials from ${clearedCount} settings files`, 'success');

                // 4. Clear dashboard error cache
                log('Clearing dashboard error cache...', 'info');
                localStorage.removeItem('dashboard_shown_errors');
                log('‚úì Dashboard error cache cleared', 'success');

                // 5. Show success message
                document.getElementById('success').style.display = 'block';
                log('üéâ Cleanup complete!', 'success');

                // 6. Redirect to app
                setTimeout(() => {
                    log('Redirecting to ARTLEE CRM...', 'info');
                    window.location.href = 'http://localhost:2222';
                }, 2000);

            } catch (error) {
                log(`‚ùå Error during cleanup: ${error.message}`, 'error');
                alert('Error clearing credentials. Check console for details.');
                console.error(error);
            }
        }
    </script>
</body>
</html>
