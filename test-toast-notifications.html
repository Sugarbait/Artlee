<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Toast Notification Diagnostics</title>
  <style>
    body {
      font-family: monospace;
      padding: 20px;
      background: #1a1a1a;
      color: #00ff00;
    }
    .section {
      margin: 20px 0;
      padding: 15px;
      border: 1px solid #333;
      background: #0a0a0a;
    }
    button {
      background: #00ff00;
      color: #000;
      border: none;
      padding: 10px 20px;
      margin: 5px;
      cursor: pointer;
      font-family: monospace;
      font-weight: bold;
    }
    button:hover {
      background: #00cc00;
    }
    .log {
      background: #000;
      padding: 10px;
      margin: 10px 0;
      border-left: 3px solid #00ff00;
      max-height: 400px;
      overflow-y: auto;
    }
    .error { color: #ff0000; }
    .success { color: #00ff00; }
    .warning { color: #ffaa00; }
    .info { color: #00aaff; }
  </style>
</head>
<body>
  <h1>üîî Toast Notification System Diagnostics</h1>

  <div class="section">
    <h2>Service Status</h2>
    <button onclick="checkServiceStatus()">Check Service Status</button>
    <button onclick="getDebugInfo()">Get Debug Info</button>
    <div id="status" class="log"></div>
  </div>

  <div class="section">
    <h2>Test Notifications</h2>
    <button onclick="testCallNotification()">Test Call Notification</button>
    <button onclick="testSMSNotification()">Test SMS Notification</button>
    <div id="test-results" class="log"></div>
  </div>

  <div class="section">
    <h2>Supabase Connection</h2>
    <button onclick="checkSupabaseConnection()">Check Supabase Connection</button>
    <button onclick="checkRealtimeChannels()">Check Realtime Channels</button>
    <div id="supabase-status" class="log"></div>
  </div>

  <div class="section">
    <h2>Recent Records</h2>
    <button onclick="fetchRecentCalls()">Fetch Recent Calls</button>
    <button onclick="fetchRecentSMS()">Fetch Recent SMS</button>
    <button onclick="insertTestCall()">Insert Test Call</button>
    <button onclick="insertTestSMS()">Insert Test SMS</button>
    <div id="records" class="log"></div>
  </div>

  <div class="section">
    <h2>Console Output</h2>
    <button onclick="clearConsole()">Clear Console</button>
    <div id="console" class="log"></div>
  </div>

  <script>
    const SUPABASE_URL = 'https://cpkslvmydfdevdftieck.supabase.co'
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNwa3Nsdm15ZGZkZXZkZnRpZWNrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY5MDAyOTUsImV4cCI6MjA2MjQ3NjI5NX0.IfkIVsp3AtLOyXDW9hq9bEvnozd9IaaUay244iDhWGE'

    // Override console.log to capture output
    const originalLog = console.log
    const originalError = console.error
    const originalWarn = console.warn

    console.log = function(...args) {
      originalLog.apply(console, args)
      log('info', args.join(' '))
    }

    console.error = function(...args) {
      originalError.apply(console, args)
      log('error', args.join(' '))
    }

    console.warn = function(...args) {
      originalWarn.apply(console, args)
      log('warning', args.join(' '))
    }

    function log(type, message) {
      const consoleDiv = document.getElementById('console')
      const timestamp = new Date().toLocaleTimeString()
      consoleDiv.innerHTML += `<div class="${type}">[${timestamp}] ${message}</div>`
      consoleDiv.scrollTop = consoleDiv.scrollHeight
    }

    function clearConsole() {
      document.getElementById('console').innerHTML = ''
    }

    function output(elementId, message, type = 'info') {
      const div = document.getElementById(elementId)
      const timestamp = new Date().toLocaleTimeString()
      div.innerHTML += `<div class="${type}">[${timestamp}] ${message}</div>`
      div.scrollTop = div.scrollHeight
    }

    async function checkServiceStatus() {
      output('status', 'üîç Checking toast notification service...', 'info')

      try {
        // Check if service is available in window
        if (typeof window.toastNotificationService !== 'undefined') {
          output('status', '‚úÖ Toast service found in window', 'success')
        } else {
          output('status', '‚ö†Ô∏è Toast service not found in window (this is normal, service is internal)', 'warning')
        }

        // Check localStorage for service data
        const prefs = localStorage.getItem('toast_notification_preferences')
        if (prefs) {
          output('status', `‚úÖ Preferences found: ${prefs}`, 'success')
        } else {
          output('status', '‚ö†Ô∏è No preferences found in localStorage', 'warning')
        }

      } catch (error) {
        output('status', `‚ùå Error: ${error.message}`, 'error')
      }
    }

    async function getDebugInfo() {
      output('status', 'üîç Getting debug info from main app...', 'info')
      output('status', '‚ÑπÔ∏è Open browser console and run: window.toastNotificationService?.getDebugInfo()', 'info')
    }

    async function checkSupabaseConnection() {
      output('supabase-status', 'üîç Checking Supabase connection...', 'info')

      try {
        const response = await fetch(
          `${SUPABASE_URL}/rest/v1/calls?select=count&limit=1`,
          {
            headers: {
              'apikey': SUPABASE_KEY,
              'Authorization': `Bearer ${SUPABASE_KEY}`
            }
          }
        )

        if (response.ok) {
          output('supabase-status', '‚úÖ Supabase connection successful', 'success')
        } else {
          output('supabase-status', `‚ùå Supabase error: ${response.status}`, 'error')
        }
      } catch (error) {
        output('supabase-status', `‚ùå Connection error: ${error.message}`, 'error')
      }
    }

    async function checkRealtimeChannels() {
      output('supabase-status', 'üîç Checking realtime channels...', 'info')
      output('supabase-status', '‚ÑπÔ∏è Check browser console for realtime subscription status', 'info')
    }

    async function fetchRecentCalls() {
      output('records', 'üîç Fetching recent calls...', 'info')

      try {
        const response = await fetch(
          `${SUPABASE_URL}/rest/v1/calls?select=call_id,start_timestamp,from_number&order=start_timestamp.desc&limit=5`,
          {
            headers: {
              'apikey': SUPABASE_KEY,
              'Authorization': `Bearer ${SUPABASE_KEY}`
            }
          }
        )

        if (response.ok) {
          const calls = await response.json()
          output('records', `‚úÖ Found ${calls.length} recent calls`, 'success')
          calls.forEach((call, i) => {
            const timestamp = new Date(call.start_timestamp)
            const age = Math.round((Date.now() - timestamp.getTime()) / 1000)
            output('records', `  ${i+1}. ${call.call_id.substring(0, 20)}... (${age}s ago)`, 'info')
          })
        } else {
          output('records', `‚ùå Error: ${response.status}`, 'error')
        }
      } catch (error) {
        output('records', `‚ùå Error: ${error.message}`, 'error')
      }
    }

    async function fetchRecentSMS() {
      output('records', 'üîç Fetching recent SMS...', 'info')

      try {
        const response = await fetch(
          `${SUPABASE_URL}/rest/v1/sms_messages?select=id,created_at,content&order=created_at.desc&limit=5`,
          {
            headers: {
              'apikey': SUPABASE_KEY,
              'Authorization': `Bearer ${SUPABASE_KEY}`
            }
          }
        )

        if (response.ok) {
          const messages = await response.json()
          output('records', `‚úÖ Found ${messages.length} recent SMS`, 'success')
          messages.forEach((msg, i) => {
            const timestamp = new Date(msg.created_at)
            const age = Math.round((Date.now() - timestamp.getTime()) / 1000)
            output('records', `  ${i+1}. ${msg.id} (${age}s ago)`, 'info')
          })
        } else {
          output('records', `‚ùå Error: ${response.status}`, 'error')
        }
      } catch (error) {
        output('records', `‚ùå Error: ${error.message}`, 'error')
      }
    }

    async function insertTestCall() {
      output('records', 'üîç Inserting test call record...', 'info')

      try {
        const testCall = {
          call_id: `test_call_${Date.now()}`,
          start_timestamp: new Date().toISOString(),
          from_number: '+1234567890',
          call_status: 'completed',
          call_length_ms: 30000
        }

        const response = await fetch(
          `${SUPABASE_URL}/rest/v1/calls`,
          {
            method: 'POST',
            headers: {
              'apikey': SUPABASE_KEY,
              'Authorization': `Bearer ${SUPABASE_KEY}`,
              'Content-Type': 'application/json',
              'Prefer': 'return=representation'
            },
            body: JSON.stringify(testCall)
          }
        )

        if (response.ok) {
          output('records', `‚úÖ Test call inserted: ${testCall.call_id}`, 'success')
          output('records', '‚ÑπÔ∏è Check if toast notification appeared!', 'warning')
        } else {
          const error = await response.text()
          output('records', `‚ùå Error: ${response.status} - ${error}`, 'error')
        }
      } catch (error) {
        output('records', `‚ùå Error: ${error.message}`, 'error')
      }
    }

    async function insertTestSMS() {
      output('records', 'üîç Inserting test SMS record...', 'info')

      try {
        const testSMS = {
          id: `test_sms_${Date.now()}`,
          created_at: new Date().toISOString(),
          content: 'Test SMS for toast notification',
          direction: 'inbound',
          from_number: '+1234567890'
        }

        const response = await fetch(
          `${SUPABASE_URL}/rest/v1/sms_messages`,
          {
            method: 'POST',
            headers: {
              'apikey': SUPABASE_KEY,
              'Authorization': `Bearer ${SUPABASE_KEY}`,
              'Content-Type': 'application/json',
              'Prefer': 'return=representation'
            },
            body: JSON.stringify(testSMS)
          }
        )

        if (response.ok) {
          output('records', `‚úÖ Test SMS inserted: ${testSMS.id}`, 'success')
          output('records', '‚ÑπÔ∏è Check if toast notification appeared!', 'warning')
        } else {
          const error = await response.text()
          output('records', `‚ùå Error: ${response.status} - ${error}`, 'error')
        }
      } catch (error) {
        output('records', `‚ùå Error: ${error.message}`, 'error')
      }
    }

    function testCallNotification() {
      output('test-results', '‚ÑπÔ∏è Testing requires access to toast service in main app', 'warning')
      output('test-results', '‚ÑπÔ∏è Run this in browser console: window.toastNotificationService?.triggerTestNotification("call")', 'info')
    }

    function testSMSNotification() {
      output('test-results', '‚ÑπÔ∏è Testing requires access to toast service in main app', 'warning')
      output('test-results', '‚ÑπÔ∏è Run this in browser console: window.toastNotificationService?.triggerTestNotification("sms")', 'info')
    }

    // Initial status check
    window.addEventListener('load', () => {
      output('console', 'üîî Toast Notification Diagnostics Loaded', 'success')
      output('console', '‚ÑπÔ∏è Click buttons to run diagnostics', 'info')
    })
  </script>
</body>
</html>
